name: Dagger Pipeline CI

# When the workflow should run
on:
  workflow_dispatch:        # Allow manual trigger from GitHub UI
  push:
    branches: [main]        # Run on push to main
  pull_request:
    branches: [main]        # Run on PRs targeting main

jobs:
  # Training job
  train:
    runs-on: ubuntu-22.04   # GitHub-hosted Linux runner

    steps:
      # Fetch repository code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install Go (needed to run the Dagger pipeline)
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'              # Matches go.mod
          cache-dependency-path: dagger/go.sum

      # Install Python runtime
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # Install Python dependencies used by the pipeline
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install dagger dvc

      # Run the full ML pipeline via Dagger (training + selection)
      - name: Run Dagger pipeline
        run: |
          cd dagger
          go run pipeline.go
          cd ..

      # Upload the trained model for use in later jobs
      - name: Upload Model Artifact
        uses: actions/upload-artifact@v4
        with:
          name: model
          path: model/model.pkl

  # Validation job
  validate:
    runs-on: ubuntu-22.04
    needs: train             # Only run if train job succeeds

    steps:
      # Checkout repo (required by validator action)
      - name: Checkout repository
        uses: actions/checkout@v3

      # Download trained model artifact from train job
      - name: Download Model Artifact
        uses: actions/download-artifact@v4
        with:
          name: model
          path: model

      # Run external model validation (inference test)
      - name: Validate model
        uses: lasselundstenjensen/itu-sdse-project-model-validator@main
